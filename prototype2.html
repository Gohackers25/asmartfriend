<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DecideTogether - Group Decision Making</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
        }

        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .app-subtitle {
            font-size: 14px;
            color: #bdc3c7;
        }

        .friends-section {
            flex: 1;
        }

        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #ecf0f1;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .friend-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .avatar-initial {
            display: block;
            z-index: 0;
        }
        
        .avatar img[style*="display: none"] ~ .avatar-initial,
        .avatar img:not([src]) ~ .avatar-initial {
            display: block;
        }
        
        .avatar img:not([style*="display: none"]) ~ .avatar-initial {
            display: none;
        }

        .status-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-online {
            background: #2ecc71;
        }

        .status-away {
            background: #f39c12;
        }

        .status-pending {
            background: #e74c3c;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .friend-status {
            font-size: 12px;
            color: #bdc3c7;
        }

        .user-profile {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .user-avatar .avatar-initial {
            z-index: 0;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 5px;
        }

        .user-label {
            font-size: 12px;
            color: #bdc3c7;
        }

        .decision-type-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .decision-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .decision-type-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .chat-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .session-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-waiting {
            background: #fff3cd;
            color: #856404;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
            animation: slideIn 0.3s ease;
            line-height: 1.5;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bot {
            align-self: flex-start;
            background: white;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message-system {
            align-self: center;
            background: #e8f5e8;
            color: #2d5a2d;
            font-style: italic;
            text-align: center;
        }

        .message-notification {
            align-self: flex-start;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            max-width: 90%;
        }

        .notification-content {
            margin-bottom: 15px;
        }

        .notification-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-icon {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 16px;
        }

        .notification-title {
            font-weight: 600;
            font-size: 16px;
        }

        .response-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .response-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            font-size: 14px;
        }

        .response-btn.yes {
            background: rgba(255, 255, 255, 0.9);
            color: #2ecc71;
        }

        .response-btn.yes:hover {
            background: white;
            transform: translateY(-1px);
        }

        .response-btn.no {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .response-btn.no:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .preference-form {
            background: white;
            padding: 20px;
            border-radius: 18px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            align-self: flex-start;
            max-width: 90%;
            animation: slideIn 0.3s ease;
        }

        .form-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-icon {
            width: 40px;
            height: 40px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-weight: bold;
        }

        .form-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }

        .form-description {
            color: #5a6c7d;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #e9ecef;
            color: #5a6c7d;
        }

        .btn-secondary:hover {
            background: #dee2e6;
            transform: translateY(-1px);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 18px;
            max-width: 80px;
            margin: 10px 0;
            border: 1px solid #e9ecef;
            align-self: flex-start;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #bdc3c7;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        .decision-context-form {
            background: white;
            padding: 20px;
            border-radius: 18px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            align-self: flex-start;
            max-width: 90%;
            animation: slideIn 0.3s ease;
        }

        .context-form-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .context-form-icon {
            width: 40px;
            height: 40px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 20px;
        }

        .context-form-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }

        .user-selector {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .user-selector-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .user-selector-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .user-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .user-option {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .user-option-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 auto 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .user-option-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .user-option-avatar .avatar-initial {
            z-index: 0;
        }

        .user-option-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 200px;
            }

            .message {
                max-width: 95%;
            }

            .preference-form {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <div class="app-header">
                <div class="app-title">ü§ù DecideTogether</div>
                <div class="app-subtitle">Smart Group Decisions</div>
            </div>

            <div class="user-profile" id="userProfile" style="display: none;">
                <div class="user-avatar" id="userAvatar">
                    <span class="avatar-initial" id="userInitial">O</span>
                    <img id="userImage" src="" alt="" onerror="this.style.display='none';" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1;">
                </div>
                <div class="user-name" id="userName">Oto</div>
                <div class="user-label">Logged in as</div>
            </div>

            <div class="friends-section">
                <h3 class="section-title">Your Friends</h3>
                <div class="friends-list" id="friendsList">
                    <!-- Friends will be populated dynamically -->
                </div>
            </div>

            <div class="decision-types" id="decisionTypes" style="display: none;">
                <h3 class="section-title">Start a Decision</h3>
                <button class="decision-type-btn" onclick="startDecision('meal')">
                    üçΩÔ∏è Plan a Meal Together
                </button>
                <button class="decision-type-btn" onclick="startDecision('movie')">
                    üé¨ Choose a Movie to Watch
                </button>
                <button class="decision-type-btn" onclick="startDecision('hike')">
                    ü•æ Pick a Hike to Do
                </button>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="session-info">
                    <div class="session-title">Group Decision Chat</div>
                    <div class="session-status">
                        <div class="status-badge status-waiting" id="sessionStatus">Ready to Start</div>
                        <div style="font-size: 12px; color: #666; margin-left: 10px;" id="sessionId"></div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message message-system">
                    Welcome to DecideTogether! Please select who you are to get started.
                </div>
            </div>
        </div>
    </div>

    <!-- User Selector Modal -->
    <div class="user-selector" id="userSelector">
        <div class="user-selector-content">
            <h2 class="user-selector-title">Who are you?</h2>
            <div class="user-options">
                <div class="user-option" onclick="selectUser('Oto')">
                    <div class="user-option-avatar">
                        <span class="avatar-initial">O</span>
                        <img src="assets/Oto.png" alt="Oto" onerror="this.style.display='none';">
                    </div>
                    <div class="user-option-name">Oto</div>
                </div>
                <div class="user-option" onclick="selectUser('Tanishqa')">
                    <div class="user-option-avatar">
                        <span class="avatar-initial">T</span>
                        <img src="assets/Tanishqa.png" alt="Tanishqa" onerror="this.style.display='none';">
                    </div>
                    <div class="user-option-name">Tanishqa</div>
                </div>
                <div class="user-option" onclick="selectUser('Karthik')">
                    <div class="user-option-avatar">
                        <span class="avatar-initial">K</span>
                        <img src="assets/Karthick.png" alt="Karthik" onerror="this.style.display='none';">
                    </div>
                    <div class="user-option-name">Karthik</div>
                </div>
                <div class="user-option" onclick="selectUser('Bharath')">
                    <div class="user-option-avatar">
                        <span class="avatar-initial">B</span>
                        <img src="assets/Bharath.png" alt="Bharath" onerror="this.style.display='none';">
                    </div>
                    <div class="user-option-name">Bharath</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Session management
        let currentSessionId = null;
        let allSessions = {};
        
        // App state (now session-specific)
        let sessionActive = false;
        let currentUser = null;
        let allUsers = ['Oto', 'Tanishqa', 'Karthik', 'Bharath'];
        let friends = [];
        let responses = {};
        let sessionStarted = false;
        let awaitingUserResponse = false;
        let currentDecisionType = null;
        let decisionContext = {};
        
        // Session storage key
        const SESSIONS_STORAGE_KEY = 'decidetogether_sessions';

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const sessionStatus = document.getElementById('sessionStatus');
        const sessionIdElement = document.getElementById('sessionId');
        const userSelector = document.getElementById('userSelector');
        const userProfile = document.getElementById('userProfile');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const friendsList = document.getElementById('friendsList');
        const decisionTypes = document.getElementById('decisionTypes');

        // Session management functions
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }
        
        function saveSession() {
            if (!currentSessionId) return;
            
            const sessionData = {
                sessionId: currentSessionId,
                user: currentUser,
                sessionActive,
                responses,
                sessionStarted,
                awaitingUserResponse,
                currentDecisionType,
                decisionContext,
                timestamp: Date.now()
            };
            
            allSessions[currentSessionId] = sessionData;
            localStorage.setItem(SESSIONS_STORAGE_KEY, JSON.stringify(allSessions));
        }
        
        function loadSessions() {
            const stored = localStorage.getItem(SESSIONS_STORAGE_KEY);
            if (stored) {
                try {
                    allSessions = JSON.parse(stored);
                } catch (e) {
                    console.log('Error loading sessions:', e);
                    allSessions = {};
                }
            }
        }
        
        function getOrCreateSession(user) {
            // Look for an active session that this user can join
            const activeSession = Object.values(allSessions).find(session => 
                session.sessionActive && 
                (Date.now() - session.timestamp) < 60 * 60 * 1000 // 1 hour for active sessions
            );
            
            if (activeSession) {
                return activeSession.sessionId;
            }
            
            // Look for existing session for this user
            const existingSession = Object.values(allSessions).find(session => 
                session.user === user && 
                (Date.now() - session.timestamp) < 24 * 60 * 60 * 1000 // 24 hours
            );
            
            if (existingSession) {
                return existingSession.sessionId;
            }
            
            // Create new session
            const newSessionId = generateSessionId();
            return newSessionId;
        }
        
        function loadSessionState(sessionId) {
            const session = allSessions[sessionId];
            if (session) {
                currentUser = session.user;
                sessionActive = session.sessionActive || false;
                responses = session.responses || {};
                sessionStarted = session.sessionStarted || false;
                awaitingUserResponse = session.awaitingUserResponse || false;
                currentDecisionType = session.currentDecisionType || null;
                decisionContext = session.decisionContext || {};
                
                // Update timestamp
                session.timestamp = Date.now();
                saveSession();
            }
        }
        
        function broadcastToSession(sessionId, eventType, data) {
            // Simulate broadcasting by storing events in localStorage
            const eventKey = `session_event_${sessionId}`;
            const event = {
                type: eventType,
                data: data,
                timestamp: Date.now(),
                from: currentUser
            };
            
            let events = [];
            const stored = localStorage.getItem(eventKey);
            if (stored) {
                try {
                    events = JSON.parse(stored);
                } catch (e) {
                    events = [];
                }
            }
            
            events.push(event);
            // Keep only last 50 events
            if (events.length > 50) {
                events = events.slice(-50);
            }
            
            localStorage.setItem(eventKey, JSON.stringify(events));
        }
        
        function listenForSessionEvents() {
            if (!currentSessionId) return;
            
            const eventKey = `session_event_${currentSessionId}`;
            const lastCheckKey = `last_check_${currentSessionId}_${currentUser}`;
            
            const lastCheck = localStorage.getItem(lastCheckKey) || '0';
            const events = JSON.parse(localStorage.getItem(eventKey) || '[]');
            
            const newEvents = events.filter(event => 
                event.timestamp > parseInt(lastCheck) && 
                event.from !== currentUser
            );
            
            newEvents.forEach(event => {
                handleSessionEvent(event);
            });
            
            if (newEvents.length > 0) {
                localStorage.setItem(lastCheckKey, Date.now().toString());
            }
        }
        
        let lastResetTime = 0;
        
        function handleSessionEvent(event) {
            // Prevent processing events that are too old (more than 5 minutes)
            if (Date.now() - event.timestamp > 5 * 60 * 1000) {
                return;
            }
            
            switch (event.type) {
                case 'user_joined':
                    addMessage(`üéâ ${event.data.user} joined the session!`, 'system');
                    break;
                case 'decision_started':
                    if (event.data.initiator !== currentUser) {
                        addMessage(`üìã ${event.data.initiator} started a ${event.data.type} decision: ${event.data.context}`, 'system');
                        // Show notification for other users
                        setTimeout(() => {
                            if (!awaitingUserResponse) {
                                addNotificationMessage();
                                const notifText = document.getElementById('notificationText');
                                if (notifText) {
                                    notifText.textContent = event.data.invitationText;
                                }
                            }
                        }, 1000);
                    }
                    break;
                case 'response_submitted':
                    if (event.data.user !== currentUser) {
                        let message = event.data.participating 
                            ? `‚úÖ ${event.data.user} is participating!`
                            : `‚ùå ${event.data.user} can't make it`;
                        addMessage(message, 'system');
                        
                        // Update responses
                        responses[event.data.user] = event.data.response;
                        
                        // Check if all responses collected
                        checkAllResponsesCollected();
                    }
                    break;
                case 'session_reset':
                    // Prevent rapid-fire reset events (debounce with 5 second window)
                    if (event.data.initiator !== currentUser && 
                        event.timestamp > lastResetTime + 5000) {
                        lastResetTime = event.timestamp;
                        addMessage('üîÑ Session has been reset by ' + event.data.initiator, 'system');
                        resetSessionFromEvent();
                    }
                    break;
            }
        }
        
        function checkAllResponsesCollected() {
            const totalUsers = allUsers.length;
            const responseCount = Object.keys(responses).length;
            
            if (responseCount >= totalUsers && sessionActive) {
                setTimeout(() => {
                    generateRestaurantRecommendation();
                }, 2000);
            }
        }

        // Initialize app
        function init() {
            loadSessions();
            
            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const userParam = urlParams.get('user');
            
            if (userParam) {
                // Normalize the user parameter (capitalize first letter)
                const normalizedUser = userParam.charAt(0).toUpperCase() + userParam.slice(1).toLowerCase();
                
                // Check if it's a valid user
                if (allUsers.includes(normalizedUser)) {
                    // Get or create session for this user
                    currentSessionId = getOrCreateSession(normalizedUser);
                    loadSessionState(currentSessionId);
                    
                    // Auto-select the user and skip popup
                    selectUser(normalizedUser);
                    
                    // Start listening for session events
                    setInterval(listenForSessionEvents, 2000);
                    return;
                }
            }
            
            // No valid user parameter, show the selector modal
            console.log('üí° Tip: You can skip user selection by adding ?user=oto (or tanishqa, karthik, bharath) to the URL');
            // App is initialized, waiting for user selection
        }

        function selectUser(selectedUser) {
            currentUser = selectedUser;
            friends = allUsers.filter(user => user !== selectedUser);
            
            // Get or create session if not already set
            if (!currentSessionId) {
                currentSessionId = getOrCreateSession(selectedUser);
                loadSessionState(currentSessionId);
                // Start listening for session events
                setInterval(listenForSessionEvents, 2000);
            }
            
            // Update URL to reflect selected user
            const url = new URL(window.location);
            url.searchParams.set('user', selectedUser.toLowerCase());
            window.history.replaceState({}, '', url);
            
            // Broadcast user joined event
            broadcastToSession(currentSessionId, 'user_joined', { user: selectedUser });
            
            // Update UI
            userSelector.style.display = 'none';
            userProfile.style.display = 'block';
            userName.textContent = selectedUser;
            
            // Set user avatar and image
            const userInitial = document.getElementById('userInitial');
            const userImage = document.getElementById('userImage');
            
            if (userInitial && userImage) {
                userInitial.textContent = selectedUser.charAt(0);
                
                // Handle special case for Karthik vs Karthick filename
                let imageName = selectedUser;
                if (selectedUser === 'Karthik') {
                    imageName = 'Karthick';
                }
                
                userImage.src = `assets/${imageName}.png`;
                userImage.alt = selectedUser;
                
                // Ensure image is visible on load
                userImage.style.display = 'block';
                userImage.onload = function() {
                    console.log(`User image loaded for ${selectedUser}`);
                };
                userImage.onerror = function() {
                    console.log(`User image failed to load for ${selectedUser}, showing initial instead`);
                    this.style.display = 'none';
                };
            } else {
                console.error('User avatar elements not found');
            }
            
            decisionTypes.style.display = 'block';
            
            // Populate friends list
            friendsList.innerHTML = '';
            friends.forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.className = 'friend-item';
                
                // Handle special case for Karthik vs Karthick filename
                let imageName = friend;
                if (friend === 'Karthik') {
                    imageName = 'Karthick'; // Use the actual filename
                }
                
                friendDiv.innerHTML = `
                    <div class="avatar">
                        <span class="avatar-initial">${friend.charAt(0)}</span>
                        <img src="assets/${imageName}.png" alt="${friend}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${friend}</div>
                    </div>
                `;
                friendsList.appendChild(friendDiv);
            });
            
            // Clear chat and add welcome message (only if not resuming a session)
            if (!sessionStarted) {
                chatMessages.innerHTML = '';
                addMessage(`Welcome ${selectedUser}! Choose a decision type to start planning with your friends.`, 'system');
            }
            
            // Update session ID display
            if (sessionIdElement && currentSessionId) {
                sessionIdElement.textContent = `Session: ${currentSessionId.slice(-8)}`;
            }
            
            // Save updated session state
            saveSession();
        }

        function addMessage(text, type = 'bot', delay = 0) {
            setTimeout(() => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${type}`;
                messageDiv.innerHTML = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, delay);
        }

        function addNotificationMessage(delay = 0) {
            setTimeout(() => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-notification';
                messageDiv.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-header">
                            <div class="notification-icon">ü§ù</div>
                            <div class="notification-title">Decision Session Invitation</div>
                        </div>
                        <div id="notificationText">You've been invited to join a group decision session! Your input is valuable for making the best choice together.</div>
                    </div>
                    <div class="response-buttons">
                        <button class="response-btn yes" onclick="respondToInvitation(true)">Count Me In! üôã‚Äç‚ôÄÔ∏è</button>
                        <button class="response-btn no" onclick="respondToInvitation(false)">Can't Participate üòî</button>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                awaitingUserResponse = true;
            }, delay);
        }

        function addPreferencesForm(delay = 0) {
            setTimeout(() => {
                let formFields = '';
                let formDescription = '';
                
                switch(currentDecisionType) {
                    case 'meal':
                        formDescription = 'Share your dining preferences and requirements.';
                        formFields = `
                            <div class="form-group">
                                <label class="form-label">Dietary Restrictions</label>
                                <input type="text" class="form-input" id="restrictionsInput" placeholder="e.g., vegetarian, allergies, gluten-free">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cuisine Preferences</label>
                                <input type="text" class="form-input" id="cuisineInput" placeholder="e.g., Italian, Thai, no spicy food">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Budget Range</label>
                                <input type="text" class="form-input" id="budgetInput" placeholder="e.g., $, $$, $$$, doesn't matter">
                            </div>
                        `;
                        break;
                    case 'movie':
                        formDescription = 'Tell us your movie preferences for the group viewing.';
                        formFields = `
                            <div class="form-group">
                                <label class="form-label">Genre Preferences</label>
                                <input type="text" class="form-input" id="genreInput" placeholder="e.g., comedy, action, no horror">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Movie Length</label>
                                <input type="text" class="form-input" id="lengthInput" placeholder="e.g., under 2 hours, doesn't matter">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Specific Suggestions</label>
                                <input type="text" class="form-input" id="suggestionsInput" placeholder="e.g., recent releases, classics, specific titles">
                            </div>
                        `;
                        break;
                    case 'hike':
                        formDescription = 'Share your hiking preferences and fitness level.';
                        formFields = `
                            <div class="form-group">
                                <label class="form-label">Fitness Level</label>
                                <input type="text" class="form-input" id="fitnessInput" placeholder="e.g., beginner, intermediate, expert">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Distance Preference</label>
                                <input type="text" class="form-input" id="distanceInput" placeholder="e.g., under 5 miles, 5-10 miles, any">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Trail Features</label>
                                <input type="text" class="form-input" id="featuresInput" placeholder="e.g., waterfalls, views, shade, dog-friendly">
                            </div>
                        `;
                        break;
                }
                
                const formDiv = document.createElement('div');
                formDiv.className = 'preference-form';
                formDiv.innerHTML = `
                    <div class="form-header">
                        <div class="form-icon">üìù</div>
                        <div class="form-title">Your Preferences</div>
                    </div>
                    <div class="form-description">${formDescription}</div>
                    ${formFields}
                    <div class="form-buttons">
                        <button class="btn btn-primary" onclick="submitPreferences()">Submit Preferences</button>
                        <button class="btn btn-secondary" onclick="skipPreferences()">Skip</button>
                    </div>
                `;
                chatMessages.appendChild(formDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                awaitingUserResponse = true;
            }, delay);
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            typingDiv.id = 'typingIndicator';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function startDecision(type) {
            currentDecisionType = type;
            sessionStarted = true;
            decisionTypes.style.display = 'none';
            
            // Update session status
            sessionStatus.textContent = 'Setting up...';
            sessionStatus.className = 'status-badge status-waiting';
            
            // Clear chat
            chatMessages.innerHTML = '';
            
            // Show context form based on decision type
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                
                let formIcon, formTitle, formDescription, formFields;
                
                switch(type) {
                    case 'meal':
                        formIcon = 'üçΩÔ∏è';
                        formTitle = 'Plan a Meal';
                        formDescription = 'Let\'s gather some details about the meal you want to plan.';
                        formFields = `
                            <div class="form-group">
                                <label class="form-label">Type of Meal</label>
                                <input type="text" class="form-input" id="mealType" placeholder="e.g., Lunch, Dinner, Brunch">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Day & Time</label>
                                <input type="text" class="form-input" id="mealTime" placeholder="e.g., Saturday 7 PM">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Additional Details</label>
                                <input type="text" class="form-input" id="mealDetails" placeholder="e.g., Birthday celebration, casual meetup">
                            </div>
                        `;
                        break;
                    case 'movie':
                        formIcon = 'üé¨';
                        formTitle = 'Choose a Movie';
                        formDescription = 'Tell me about your movie night plans.';
                        formFields = `
                            <div class="form-group">
                                <label class="form-label">When to Watch</label>
                                <input type="text" class="form-input" id="movieTime" placeholder="e.g., Friday evening, Tonight">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Where to Watch</label>
                                <input type="text" class="form-input" id="movieLocation" placeholder="e.g., My place, Theater, Online">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Movie Preferences</label>
                                <input type="text" class="form-input" id="moviePrefs" placeholder="e.g., Comedy, no horror, recent releases">
                            </div>
                        `;
                        break;
                    case 'hike':
                        formIcon = 'ü•æ';
                        formTitle = 'Pick a Hike';
                        formDescription = 'Let\'s plan your group hiking adventure.';
                        formFields = `
                            <div class="form-group">
                                <label class="form-label">When to Hike</label>
                                <input type="text" class="form-input" id="hikeTime" placeholder="e.g., Sunday morning, Next weekend">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Difficulty Level</label>
                                <input type="text" class="form-input" id="hikeDifficulty" placeholder="e.g., Easy, Moderate, Challenging">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Preferences</label>
                                <input type="text" class="form-input" id="hikePrefs" placeholder="e.g., Waterfalls, Views, Under 5 miles">
                            </div>
                        `;
                        break;
                }
                
                const formDiv = document.createElement('div');
                formDiv.className = 'decision-context-form';
                formDiv.innerHTML = `
                    <div class="context-form-header">
                        <div class="context-form-icon">${formIcon}</div>
                        <div class="context-form-title">${formTitle}</div>
                    </div>
                    <div class="form-description">${formDescription}</div>
                    ${formFields}
                    <div class="form-buttons">
                        <button class="btn btn-primary" onclick="submitDecisionContext()">Start Planning</button>
                        <button class="btn btn-secondary" onclick="cancelDecision()">Cancel</button>
                    </div>
                `;
                chatMessages.appendChild(formDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 500);
        }

        function submitDecisionContext() {
            // Gather context based on decision type
            switch(currentDecisionType) {
                case 'meal':
                    decisionContext = {
                        type: 'meal',
                        mealType: document.getElementById('mealType').value || 'Dinner',
                        time: document.getElementById('mealTime').value || 'This weekend',
                        details: document.getElementById('mealDetails').value || 'Casual get-together'
                    };
                    break;
                case 'movie':
                    decisionContext = {
                        type: 'movie',
                        time: document.getElementById('movieTime').value || 'This weekend',
                        location: document.getElementById('movieLocation').value || 'Someone\'s place',
                        preferences: document.getElementById('moviePrefs').value || 'Open to suggestions'
                    };
                    break;
                case 'hike':
                    decisionContext = {
                        type: 'hike',
                        time: document.getElementById('hikeTime').value || 'This weekend',
                        difficulty: document.getElementById('hikeDifficulty').value || 'Moderate',
                        preferences: document.getElementById('hikePrefs').value || 'Scenic views'
                    };
                    break;
            }
            
            // Remove form
            const form = document.querySelector('.decision-context-form');
            if (form) form.remove();
            
            // Start the session
            startDecisionSession();
        }

        function cancelDecision() {
            sessionStarted = false;
            decisionTypes.style.display = 'block';
            sessionStatus.textContent = 'Ready to Start';
            sessionStatus.className = 'status-badge status-waiting';
            chatMessages.innerHTML = '';
            addMessage(`Decision cancelled. Choose a decision type when you're ready.`, 'system');
        }

        function startDecisionSession() {
            sessionActive = true;

            // Update session status
            sessionStatus.textContent = 'Active Session';
            sessionStatus.className = 'status-badge status-active';
            
            // Save session state
            saveSession();

            // Add initial messages
            let contextMessage = '';
            switch(currentDecisionType) {
                case 'meal':
                    contextMessage = `Planning a ${decisionContext.mealType} for ${decisionContext.time}. ${decisionContext.details}`;
                    break;
                case 'movie':
                    contextMessage = `Choosing a movie to watch ${decisionContext.time} at ${decisionContext.location}. Preferences: ${decisionContext.preferences}`;
                    break;
                case 'hike':
                    contextMessage = `Planning a ${decisionContext.difficulty} hike for ${decisionContext.time}. Looking for: ${decisionContext.preferences}`;
                    break;
            }
            
            addMessage(`üéâ ${currentUser} started a decision session!`, 'system');
            addMessage(`üìã ${contextMessage}`, 'system');

            // Broadcast decision started event
            let invitationText = '';
            switch(currentDecisionType) {
                case 'meal':
                    invitationText = `${currentUser} is planning a ${decisionContext.mealType} for ${decisionContext.time}. ${decisionContext.details}. Are you interested in joining?`;
                    break;
                case 'movie':
                    invitationText = `${currentUser} wants to watch a movie ${decisionContext.time} at ${decisionContext.location}. Looking for: ${decisionContext.preferences}. Want to join?`;
                    break;
                case 'hike':
                    invitationText = `${currentUser} is organizing a ${decisionContext.difficulty} hike for ${decisionContext.time}. Looking for: ${decisionContext.preferences}. Are you in?`;
                    break;
            }
            
            broadcastToSession(currentSessionId, 'decision_started', {
                initiator: currentUser,
                type: currentDecisionType,
                context: contextMessage,
                invitationText: invitationText
            });

            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                addMessage(`Great! I'll help your group decide on the best option. Let me invite your friends and gather their input based on: ${contextMessage}`, 'bot');

                // Send notifications to friends
                setTimeout(() => {
                    sendNotificationsToFriends();
                }, 1500);
            }, 1000);
        }

        function sendNotificationsToFriends() {
            addMessage('üì§ Sending invitations to all friends...', 'system');

            // Update notification text based on decision type
            let notificationContent = '';
            switch(currentDecisionType) {
                case 'meal':
                    notificationContent = `${currentUser} is planning a ${decisionContext.mealType} for ${decisionContext.time}. ${decisionContext.details}. Are you interested in joining?`;
                    break;
                case 'movie':
                    notificationContent = `${currentUser} wants to watch a movie ${decisionContext.time} at ${decisionContext.location}. Looking for: ${decisionContext.preferences}. Want to join?`;
                    break;
                case 'hike':
                    notificationContent = `${currentUser} is organizing a ${decisionContext.difficulty} hike for ${decisionContext.time}. Looking for: ${decisionContext.preferences}. Are you in?`;
                    break;
            }

            // Show notification in chat for the session initiator
            setTimeout(() => {
                addNotificationMessage();
                // Update the notification text
                const notifText = document.getElementById('notificationText');
                if (notifText) {
                    notifText.textContent = notificationContent;
                }
            }, 2000);
        }

        function respondToInvitation(accepted) {
            if (!awaitingUserResponse) return;
            awaitingUserResponse = false;

            // Disable the buttons in the notification
            const responseButtons = document.querySelectorAll('.response-btn');
            responseButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });

            if (accepted) {
                let acceptMessage = '';
                switch(currentDecisionType) {
                    case 'meal':
                        acceptMessage = `‚úÖ I'm in for the ${decisionContext.mealType.toLowerCase()}! üçΩÔ∏è`;
                        break;
                    case 'movie':
                        acceptMessage = '‚úÖ Count me in for movie night! üé¨';
                        break;
                    case 'hike':
                        acceptMessage = '‚úÖ I\'m joining the hike! ü•æ';
                        break;
                    default:
                        acceptMessage = '‚úÖ I\'m in! Happy to contribute to the group decision.';
                }
                addMessage(acceptMessage, 'user');
                
                // Store response and broadcast
                responses[currentUser] = { participating: true };
                broadcastToSession(currentSessionId, 'response_submitted', {
                    user: currentUser,
                    participating: true,
                    response: responses[currentUser]
                });
                saveSession();

                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    
                    let botResponse = '';
                    switch(currentDecisionType) {
                        case 'meal':
                            botResponse = `Great! I'm excited you can join the ${decisionContext.mealType.toLowerCase()}. Let me gather your dining preferences to find the perfect restaurant for everyone.`;
                            break;
                        case 'movie':
                            botResponse = 'Awesome! Movie night will be fun. Let me collect your movie preferences to find something everyone will enjoy.';
                            break;
                        case 'hike':
                            botResponse = 'Perfect! The hike will be great. Let me gather your hiking preferences to find a trail that works for everyone.';
                            break;
                        default:
                            botResponse = 'Awesome! I am glad you can contribute. Let me gather your input and preferences to help the group make the best decision together.';
                    }
                    addMessage(botResponse, 'bot');

                    setTimeout(() => {
                        addPreferencesForm();
                    }, 1500);
                }, 1000);
            } else {
                let declineMessage = '';
                switch(currentDecisionType) {
                    case 'meal':
                        declineMessage = `‚ùå Sorry, I can't make it to the ${decisionContext.mealType.toLowerCase()}.`;
                        break;
                    case 'movie':
                        declineMessage = '‚ùå Sorry, I can\'t join movie night.';
                        break;
                    case 'hike':
                        declineMessage = '‚ùå Sorry, I can\'t make it to the hike.';
                        break;
                    default:
                        declineMessage = '‚ùå Sorry, I can\'t participate in this decision.';
                }
                addMessage(declineMessage, 'user');
                responses[currentUser] = { participating: false };
                
                // Broadcast decline response
                broadcastToSession(currentSessionId, 'response_submitted', {
                    user: currentUser,
                    participating: false,
                    response: responses[currentUser]
                });
                saveSession();

                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    
                    let botDeclineResponse = '';
                    switch(currentDecisionType) {
                        case 'meal':
                            botDeclineResponse = `No worries! I'll let you know what restaurant the group decides on for the ${decisionContext.mealType.toLowerCase()}. Maybe next time! üòä`;
                            break;
                        case 'movie':
                            botDeclineResponse = 'No problem! I will let you know what movie the group picks. Hope you can join the next movie night! üòä';
                            break;
                        case 'hike':
                            botDeclineResponse = 'That is okay! I will share which trail the group chooses. Hope you can join the next hiking adventure! üòä';
                            break;
                        default:
                            botDeclineResponse = 'No problem at all! I will let you know the outcome of the group decision. Thanks for letting me know! üòä';
                    }
                    addMessage(botDeclineResponse, 'bot');
                }, 1500);
            }
        }

        function submitPreferences() {
            if (!awaitingUserResponse) return;
            awaitingUserResponse = false;

            let userPrefs = {};
            let summary = 'üìù Here\'s my input:\n';
            
            switch(currentDecisionType) {
                case 'meal':
                    userPrefs = {
                        restrictions: document.getElementById('restrictionsInput').value,
                        cuisine: document.getElementById('cuisineInput').value,
                        budget: document.getElementById('budgetInput').value
                    };
                    if (userPrefs.restrictions) summary += `üö´ Dietary: ${userPrefs.restrictions}\n`;
                    if (userPrefs.cuisine) summary += `üçΩÔ∏è Cuisine: ${userPrefs.cuisine}\n`;
                    if (userPrefs.budget) summary += `üí∞ Budget: ${userPrefs.budget}\n`;
                    break;
                case 'movie':
                    userPrefs = {
                        genre: document.getElementById('genreInput').value,
                        length: document.getElementById('lengthInput').value,
                        suggestions: document.getElementById('suggestionsInput').value
                    };
                    if (userPrefs.genre) summary += `üé≠ Genres: ${userPrefs.genre}\n`;
                    if (userPrefs.length) summary += `‚è±Ô∏è Length: ${userPrefs.length}\n`;
                    if (userPrefs.suggestions) summary += `üí° Suggestions: ${userPrefs.suggestions}\n`;
                    break;
                case 'hike':
                    userPrefs = {
                        fitness: document.getElementById('fitnessInput').value,
                        distance: document.getElementById('distanceInput').value,
                        features: document.getElementById('featuresInput').value
                    };
                    if (userPrefs.fitness) summary += `üí™ Fitness: ${userPrefs.fitness}\n`;
                    if (userPrefs.distance) summary += `üìè Distance: ${userPrefs.distance}\n`;
                    if (userPrefs.features) summary += `üèûÔ∏è Features: ${userPrefs.features}\n`;
                    break;
            }

            // Disable the form
            const formButtons = document.querySelectorAll('.preference-form .btn');
            const formInputs = document.querySelectorAll('.preference-form .form-input');
            formButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });
            formInputs.forEach(input => {
                input.disabled = true;
                input.style.backgroundColor = '#f8f9fa';
            });

            // Store user preferences
            responses[currentUser] = {
                participating: true,
                ...userPrefs
            };
            
            // Broadcast preferences
            broadcastToSession(currentSessionId, 'response_submitted', {
                user: currentUser,
                participating: true,
                response: responses[currentUser]
            });
            saveSession();

            if (Object.values(userPrefs).every(val => !val)) {
                summary = '‚ú® No specific requirements - I\'m flexible!';
            }

            addMessage(summary, 'user');

            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                addMessage('Perfect! I\'ve received your input. I\'ll analyze everyone\'s priorities and preferences to help the group reach the best decision together. Every perspective matters! üéØ', 'bot');
            }, 1500);
        }

        function skipPreferences() {
            if (!awaitingUserResponse) return;
            awaitingUserResponse = false;

            // Disable the form
            const formButtons = document.querySelectorAll('.preference-form .btn');
            formButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });

            responses[currentUser] = {
                participating: true,
                priorities: '',
                constraints: '',
                preferences: ''
            };
            
            // Broadcast skip response
            broadcastToSession(currentSessionId, 'response_submitted', {
                user: currentUser,
                participating: true,
                response: responses[currentUser]
            });
            saveSession();

            addMessage('‚è≠Ô∏è No specific input - I\'m flexible with the group!', 'user');

            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                addMessage('Got it! Your flexibility helps the group. I\'ll still make sure to consider all perspectives to find the best solution for everyone. üòä', 'bot');
            }, 1500);
        }


        function generateRestaurantRecommendation() {
            const participants = Object.entries(responses).filter(([name, data]) => data.participating);

            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();

                if (participants.length < 2) {
                    addMessage('It looks like not enough people can make it this time. I\'ll help you plan again when more friends are available! ü§ó', 'bot');
                    setTimeout(() => {
                        resetSession();
                    }, 3000);
                    return;
                }

                addMessage(`Excellent! I have input from everyone. Let me analyze the perspectives from ${participants.length} participants to find the best group decision... üîç`, 'bot');

                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();

                    // Analyze preferences based on decision type
                    let analysisMessage = '';
                    let recommendationMessage = '';
                    
                    switch(currentDecisionType) {
                        case 'meal':
                            const restrictions = participants.map(p => p[1].restrictions).filter(a => a).join(', ');
                            const cuisines = participants.map(p => p[1].cuisine).filter(r => r).join(', ');
                            const budgets = participants.map(p => p[1].budget).filter(c => c).join(', ');
                            
                            analysisMessage = `üìä <strong>Group Analysis Complete!</strong><br><br>
                            üö´ <strong>Dietary Restrictions:</strong> ${restrictions || 'None reported'}<br>
                            üçΩÔ∏è <strong>Cuisine Preferences:</strong> ${cuisines || 'Open to anything'}<br>
                            üí∞ <strong>Budget Range:</strong> ${budgets || 'Flexible'}`;
                            
                            recommendationMessage = `üéØ <strong>Restaurant Recommendation:</strong><br><br>
                            <strong>üèÜ Olive & Thyme Mediterranean Bistro</strong><br>
                            üìç Downtown Location<br>
                            ‚≠ê 4.8/5 stars (1,247 reviews)<br>
                            üí∞ $$ - Moderate pricing<br>
                            üïí Available ${decisionContext.time}<br><br>
                            
                            <strong>‚úÖ Perfect for your group:</strong><br>
                            ‚Ä¢ Accommodates all dietary restrictions (vegetarian, gluten-free options)<br>
                            ‚Ä¢ Shellfish-free preparation available<br>
                            ‚Ä¢ Mediterranean cuisine with Italian influences<br>
                            ‚Ä¢ Fits budget range<br><br>
                            
                            <strong>üìä Confidence Level:</strong> 92% group alignment<br><br>
                            Shall I make a reservation for ${participants.length} people? üçΩÔ∏è`;
                            break;
                            
                        case 'movie':
                            const genres = participants.map(p => p[1].genre).filter(a => a).join(', ');
                            const lengths = participants.map(p => p[1].length).filter(r => r).join(', ');
                            const suggestions = participants.map(p => p[1].suggestions).filter(c => c).join(', ');
                            
                            analysisMessage = `üìä <strong>Group Analysis Complete!</strong><br><br>
                            üé≠ <strong>Genre Preferences:</strong> ${genres || 'Open to anything'}<br>
                            ‚è±Ô∏è <strong>Length Preferences:</strong> ${lengths || 'Flexible'}<br>
                            üí° <strong>Suggestions:</strong> ${suggestions || 'Open to recommendations'}`;
                            
                            recommendationMessage = `üéØ <strong>Movie Recommendation:</strong><br><br>
                            <strong>üèÜ "Guardians of the Galaxy Vol. 3"</strong><br>
                            üé¨ Action/Comedy/Sci-Fi<br>
                            ‚è±Ô∏è 2h 30min<br>
                            ‚≠ê 8.1/10 IMDb rating<br>
                            üìÖ Available to watch ${decisionContext.time}<br><br>
                            
                            <strong>‚úÖ Great choice because:</strong><br>
                            ‚Ä¢ Balances action and comedy preferences<br>
                            ‚Ä¢ Sci-fi adventure as requested<br>
                            ‚Ä¢ Recent release with great reviews<br>
                            ‚Ä¢ Perfect for group viewing<br><br>
                            
                            <strong>üìä Confidence Level:</strong> 89% group alignment<br><br>
                            Ready to watch at ${decisionContext.location}? üé¨`;
                            break;
                            
                        case 'hike':
                            const fitness = participants.map(p => p[1].fitness).filter(a => a).join(', ');
                            const distances = participants.map(p => p[1].distance).filter(r => r).join(', ');
                            const features = participants.map(p => p[1].features).filter(c => c).join(', ');
                            
                            analysisMessage = `üìä <strong>Group Analysis Complete!</strong><br><br>
                            üí™ <strong>Fitness Levels:</strong> ${fitness || 'Mixed'}<br>
                            üìè <strong>Distance Preferences:</strong> ${distances || 'Flexible'}<br>
                            üèûÔ∏è <strong>Desired Features:</strong> ${features || 'Open to suggestions'}`;
                            
                            recommendationMessage = `üéØ <strong>Hike Recommendation:</strong><br><br>
                            <strong>üèÜ Cascade Falls Trail</strong><br>
                            üìç Regional Park - 15 minutes away<br>
                            üìè 4.2 miles moderate loop<br>
                            ‚è±Ô∏è 2-3 hours estimated time<br>
                            üåä Beautiful waterfall views<br><br>
                            
                            <strong>‚úÖ Perfect for your group:</strong><br>
                            ‚Ä¢ Suitable for beginner to intermediate fitness<br>
                            ‚Ä¢ Under 5 miles as preferred<br>
                            ‚Ä¢ Features waterfalls and shaded areas<br>
                            ‚Ä¢ Scenic views without being too steep<br><br>
                            
                            <strong>üìä Confidence Level:</strong> 94% group alignment<br><br>
                            Perfect for ${decisionContext.time}! ü•æ`;
                            break;
                    }

                    addMessage(analysisMessage, 'bot');

                    setTimeout(() => {
                        showTypingIndicator();
                        setTimeout(() => {
                            hideTypingIndicator();
                            addMessage(recommendationMessage, 'bot');

                            // Reset session
                            setTimeout(() => {
                                resetSession();
                            }, 5000);
                        }, 3000);
                    }, 2000);
                }, 2500);
            }, 1500);
        }

        function resetSession() {
            sessionActive = false;
            sessionStarted = false;
            responses = {};
            awaitingUserResponse = false;
            currentDecisionType = null;
            decisionContext = {};

            decisionTypes.style.display = 'block';
            sessionStatus.textContent = 'Ready to Start';
            sessionStatus.className = 'status-badge status-waiting';
            
            // Broadcast reset event
            broadcastToSession(currentSessionId, 'session_reset', {
                initiator: currentUser
            });
            saveSession();

            addMessage('üéâ Session completed! Ready for your next group decision.', 'system');
        }
        
        function resetSessionFromEvent() {
            // Reset session state without broadcasting (to prevent infinite loop)
            sessionActive = false;
            sessionStarted = false;
            responses = {};
            awaitingUserResponse = false;
            currentDecisionType = null;
            decisionContext = {};

            decisionTypes.style.display = 'block';
            sessionStatus.textContent = 'Ready to Start';
            sessionStatus.className = 'status-badge status-waiting';
            
            // Save session state but don't broadcast
            saveSession();
        }

        // Initialize the app
        init();
    </script>
</body>

</html>